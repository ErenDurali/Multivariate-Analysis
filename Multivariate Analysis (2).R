## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(MVN)
library(dplyr)
library(corrplot)
library(factoextra)
library(psych)
library(car)
library(labeling)
library(GGally)
library(ICSNP)
library(MASS)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(123)
df1 = read.csv("C:/Users/Eren/Desktop/Stat 467/Spotify_Youtube.csv")
df <- subset(df1[sample(nrow(df1), 2000), ],select = -c(Acousticness,Instrumentalness))
df=na.omit(df)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(df, aes(x = Danceability)) +
  geom_histogram(binwidth = 0.05, fill = "blue", color = "black") +
  labs(title = "Distribution of Danceability", x = "Danceability", y = "Frequency")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(df, aes(x = Energy, y = Valence)) +
  geom_point() +
  labs(title = "Scatter Plot of Energy vs. Valence", x = "Energy", y = "Valence")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Example: Box plot of Danceability by Album Type
ggplot(df, aes(x = Album_type, y = Danceability, fill = Album_type)) +
  geom_boxplot() +
  labs(title = "Box Plot of Danceability by Album Type", x = "Album Type", y = "Danceability")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(df, aes(x = Album_type, fill = Album_type)) +
  geom_bar() +
  labs(title = "Distribution of Album Types", x = "Album Type", y = "Count")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Conduct normality check for danceab
# You can replace 'Danceability' with the variable you want to check for normality

# Q-Q plot for normality check
qqnorm(df$Danceability)
qqline(df$Danceability, col = 2)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# H0 : The data follows normal distribution.

# H1 : The data does not follow normal distribution.
df_numeric <- Filter(is.numeric,df)
df_numeric <- na.omit(df_numeric)
result <- mvn(data = df_numeric, mvnTest = "royston")
result$multivariateNormality


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# create univariate Q-Q plots
df_split=cbind(df_numeric$Danceability,df_numeric$Energy,df_numeric$Liveness,df_numeric$Valence)
result <- mvn(data = df_split, mvnTest = "royston", univariatePlot = "qqplot")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# create univariate histograms
result <- mvn(data = df_split, mvnTest = "royston", univariatePlot = "histogram", univariateTest = "SW" )


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
df_split <- as.data.frame(df_split)
result <- mvn(data = df_split,mvnTest = "royston",multivariateOutlierMethod = "quan")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Question is to check if means of Danceability and Valence are 0.7
# H0=μ=μ0 vs  H1=μ≠μ0

y <- df %>%  dplyr::select (Danceability,Valence)
xbar <- colMeans(y)
xbar


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
test <- mvn(y, mvnTest = "mardia")
test$multivariateNormality


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
log_y <- log(y)
log_y[log_y == -Inf] <- NA
test<-mvn(log_y,mvnTest = "mardia")
test$univariateNormality # no normality


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
mu_0 <- c(0.7,0.7)
HotellingsT2(y,mu=mu_0)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# MANOVA
manova_results <- manova(cbind(Danceability, Energy, Liveness, Valence) ~ Album_type, data = df)
summary(manova_results)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary.aov(manova_results)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
df_numeric <- select_if(df,is.numeric)
df_numeric = na.omit(df_numeric)
str(df_numeric)
dim(df_numeric)
df_pca <- dplyr:: select(df, c("Danceability", "Valence", "Energy", "Liveness"))
# scatter plot for correlation test to use for pca
scatterplotMatrix(df_pca, diagonal = "histogram")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(corrplot)


# correlation of our variables and corrplot
res <- cor(df_pca,method = "pearson")
corrplot(res, method= "color", order = "hclust")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
df_pca <- scale(df_pca)
df_pca


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# correlation of scaled data set
cor(df_pca)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# we put a side base total that we can conduct pca
df_pca_1 <- df_pca[,-2]
# pca with prcomp function and summary
pca1 <- prcomp(df_pca_1)
summary(pca1)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# rotation of pca
pca1$rotation


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
fviz_eig(pca1,addlabels = TRUE)#error


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# We extract first two components and continue our analysis with them
pca <- pca1$x[,1:2]
# we check that our components are linear independent
res1 <- cor(pca, method = "pearson")
corrplot(res1, method= "color", order = "hclust")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
#interpretation of pca from correlation
cor(df_pca, pca)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# principal component regression analysis 


ols.data <- data.frame(base_total = df_pca[,2],pca)

lmodel <- lm(base_total ~ ., data = ols.data)

summary(lmodel)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(tidyverse)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
df <- read.csv("C:/Users/Eren/Desktop/Stat 467/Spotify_Youtube.csv")
df <- subset(df[sample(nrow(df), 2000), ],select = -c(Acousticness,Instrumentalness))
df_numeric <- Filter(is.numeric,df)
df_numeric <- na.omit(df_numeric)
df_split=cbind(df_numeric$Danceability,df_numeric$Energy,df_numeric$Liveness,df_numeric$Valence)
colSums(is.na(df))
df <- na.omit(df)
head(df)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
df$Description <- NULL
head(df)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(df)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(ggplot2)
album <- ggplot(df, aes(x = Album_type, alpha = Album_type))
album <- album + geom_bar(fill = "blue")
album + labs(title = "Distribution of Album Types", x = "Album Type", y = "Count") +
  scale_alpha_manual(values = c(0.8, 0.2, 0.5))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(corrplot)
cont <- sapply(df, is.numeric)
cont_data <- df[, cont]
cont_data$X <- NULL
songr <- cont_data[,0:9]
correlation1 <- cor(songr)
corrplot(correlation1, method = "color")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
popr <- cont_data[,10:13]
correlation2 <- cor(popr)
corrplot(correlation2, method = "color")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
dep <- popr[,0:2]
cor(dep)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(MVN)
result_mvn <- mvn(dep, univariateTest = "AD", univariatePlot = "histogram", bc = T)
result_mvn$univariateNormality


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(bestNormalize)
normal_dep <- dep
normalized_likes <- bestNormalize(dep$Likes, allow_lambert_s = T)
normalized_likes <- predict(normalized_likes)
normal_dep$Likes <- normalized_likes
normalized_views <- bestNormalize(dep$Views, allow_lambert_s = T)
normalized_views <- predict(normalized_views)
normal_dep$Views <- normalized_views
normal_dep_scale <- scale(normal_dep)
result_mvn <- mvn(normal_dep_scale, univariateTest = "AD", univariatePlot = "histogram")
result_mvn$univariateNormality


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
result_mvn1 <- mvn(normal_dep_scale, mvnTest = "hz",multivariatePlot = "qq")
result_mvn1$multivariateNormality


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(psych)
# first scaled data because factor analysis sensitive for different scales
normal_dep_scale <- as.data.frame(normal_dep_scale)
spotify <- songr
spotify <- spotify[,-3]
spotify_scaled <- scale(spotify)
spotify_scaled <- cbind(normal_dep_scale,spotify)
spotify_scaled <- as.data.frame(spotify_scaled)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis1 <- fa(spotify_scaled[, c("Views", "Likes")], rotate = "varimax",nfactors = 1)
summary(factor_analysis1)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis1$loadings


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis2 <- fa(spotify_scaled[, c("Views", "Likes")], rotate = "promax",nfactors = 1)
summary(factor_analysis2)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis2$loadings


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis_all <- factanal(spotify_scaled, rotation = "varimax",factors = 1)
print(factor_analysis_all)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
subset_ind <- subset(spotify_scaled[,3:10])
subset_res <- subset(spotify_scaled[,1:2])
kmeans_res <- kmeans(subset_res, centers = 2, nstart = 25)
subset_res_c <- kmeans_res$cluster
print(table(subset_res_c))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(MASS)
subset_all <- cbind(subset_ind, Cluster = subset_res_c)
lda_all <- lda(Cluster ~ . , data = subset_all)
summary(lda_all)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
dim(spotify_scaled)
cm <- cor(spotify_scaled, method="pearson")
corrplot::corrplot(cm, method= "number", order = "hclust")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
KMO(r=cm)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
print(cortest.bartlett(cm,nrow(spotify_scaled)))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
parallel <- fa.parallel(spotify_scaled, fm = "minres", fa = "fa")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis <- factanal(spotify_scaled, factors = 4)
factor_analysis


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
load <- factor_analysis$loadings[,1:2]
plot(load,type="n")
text(load,labels=names(spotify_scaled),cex=.7)
load <- factor_analysis$loadings[,3:4]
plot(load,type="n")
text(load,labels=names(spotify_scaled),cex=.7)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
names(factor_analysis$loadings[,1])[abs(factor_analysis$loadings[,1])>0.4]
names(factor_analysis$loadings[,2])[abs(factor_analysis$loadings[,2])>0.4]
names(factor_analysis$loadings[,3])[abs(factor_analysis$loadings[,3])>0.4]
names(factor_analysis$loadings[,4])[abs(factor_analysis$loadings[,4])>0.4]


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis1 <- spotify_scaled[,names(factor_analysis$loadings[,1])[abs(factor_analysis$loadings[,1])>0.4]]
summary(alpha(factor_analysis1, check.keys=TRUE))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor_analysis2 <- spotify_scaled[,names(factor_analysis$loadings[,2])[abs(factor_analysis$loadings[,2])>0.4]]
summary(alpha(factor_analysis2, check.keys=TRUE))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
scores<-factanal(spotify_scaled, factors = 4,scores="regression")$scores
head(scores)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
cm1 <- cor(scores, method="pearson")
corrplot::corrplot(cm1, method= "number", order = "hclust")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(MASS)
library(klaR)
library(ggplot2)
library(GGally)
library(mlbench)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
options(repos = c(
    fawda123 = 'https://fawda123.r-universe.dev',
    CRAN = 'https://cloud.r-project.org'))

# Install ggord
install.packages('ggord')
library(ggord)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
spotify_scaled$album_type <- as.factor(df[,"Album_type"])
GGally::ggpairs(spotify_scaled)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(123)
sample <- sample(c(TRUE, FALSE), nrow(spotify_scaled), replace=TRUE, prob=c(0.8,0.2))
train <- spotify_scaled[sample, ]
test <- spotify_scaled[!sample, ] 


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(MASS)
model_lda <- lda(album_type ~ .,data = train)
model_lda


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_pre <- predict(model_lda, train)
ldahist(data = model_pre$x[,1], g = train$album_type)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
ldahist(data = model_pre$x[,2], g = train$album_type)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggord(model_lda, train$album_type, ylim = c(-10, 10))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
#partimat(album_type~., data = train, method = "lda")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_pre1 <- predict(model_lda, train)$class
tab <- table(Predicted = model_pre1, Actual = train$album_type)
tab


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
sum(diag(tab))/sum(tab)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_pre2 <- predict(model_lda, test)$class
tab1 <- table(Predicted = model_pre2, Actual = test$album_type)
tab1


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
sum(diag(tab1))/sum(tab1)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(123)
rows <- sample(1:1884, 20)
spotify1 <- spotify_scaled
spotify1$album_type <- as.factor(df$Album_type)
cluster_sample <- spotify1[rows, ]
dm <- dist(cluster_sample[, c("Views","Likes")])
dm


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow=c(2,2),mar=c(1,2,1,2))
plot(cs <- hclust(dm, method = "single"),main = "Single Linkage")
plot(cc <- hclust(dm, method = "complete"),main = "Complete Linkage")
plot(ca <- hclust(dm, method = "average"),main = "Average Linkage")
plot(cw <- hclust(dm, method = "ward.D2"),main = "Ward Method")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow=c(1,1))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(123)
rows <- sample(1:1883, 20)
cluster_sample1 <- spotify1[rows, ]
X <- scale(cluster_sample1[, c("Views", "Likes")], center = FALSE, scale = TRUE)
dj <- dist(X)
plot(cc <- hclust(dj), main = "Spotify clustering")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
cc


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(cluster)
library(factoextra)
cluster_diana <- diana(cluster_sample[, c("Views", "Likes")], stand = TRUE)
fviz_dend(cluster_diana, cex = 0.5,
          k = 2, 
          palette = 
          )


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(car)
scatterplotMatrix(spotify_scaled)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
spotify_scaled$album_type <- as.numeric(factor(spotify_scaled$album_type, levels = c("album", "single", "compilation")))
sapply(spotify_scaled, var)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
n <- nrow(spotify_scaled)
wss <- rep(0, 6)
wss[1] <- (n - 1) * sum(sapply(spotify_scaled, var))
for (i in 2:6)
  wss[i] <- sum(kmeans(spotify_scaled,centers = i)$withinss)

plot(1:6, wss, type = "b", xlab = "Number of groups", ylab = "Within groups sum of squares")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
rge <- sapply(spotify_scaled, function(x) diff(range(x)))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
kmeans(spotify_scaled, centers = 2)$centers * rge


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
kmeans(spotify_scaled, centers = 2)$cluster


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(123)
rows <- sample(1:1876, 11)
cluster_sample2 <- spotify_scaled[rows, ]
spotify_mds <- cmdscale(cluster_sample2, k = 5, eig = TRUE)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
spotify_mds$eig


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
cumsum(abs(spotify_mds$eig))/sum(abs(spotify_mds$eig))


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
cumsum((spotify_mds$eig)^2)/sum((spotify_mds$eig)^2)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
x <- spotify_mds$points[,1]
y <- spotify_mds$points[,2]
plot(x, y, xlab = "Coordinate 1", ylab = "Coordinate 2", xlim = range(x)*1.2, type = "n")
text(x, y, labels = colnames(spotify), cex = 0.7)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(123)
library(CCA)
library(tidyverse)
require(ggplot2)
require(GGally)
require(CCA)
require(CCP)
xtabs(~album_type,data = spotify_scaled)
X <- spotify_scaled [,1:2]
Y <- spotify_scaled [,3:11]
ggpairs(X)

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggpairs(Y)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
matcor(X,Y)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
cc_a <- cc(X, Y)
cc_a$cor


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------

cc_a[3:4]


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
cc_b <- comput(X, Y, cc_a)
cc_b [3:6]


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
rho_cca <- cc_a$cor
n <- dim(X)[1]
p <- length(X)
q <- length(Y)
p.asym(rho_cca, n, p, q, tstat = "Wilks")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
p.asym(rho_cca, n, p, q, tstat = "Hotelling")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
p.asym(rho_cca, n, p, q, tstat = "Pillai")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
p.asym(rho_cca, n, p, q, tstat = "Roy")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
s1 <- diag(sqrt(diag(cov(X))))
s1 %*% cc_a$xcoef

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
s2 <- diag(sqrt(diag(cov(Y))))
s2 %*% cc_a$ycoef


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
p.asym(rho_cca, n, p, q, tstat = "Wilks")
print(cc_a$xcoef)
print(cc_a$ycoef)

